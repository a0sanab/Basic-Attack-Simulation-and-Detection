# üõ†Ô∏è Part 2: Simulating Attacks and Analyzing Traffic

This second part of the project uses the infrastructure created in [Part 1: Building the Cyber Lab Environment](README_PART1.md) to demonstrate several real-world cyberattacks in a controlled Azure environment, showcasing both offensive techniques (from a Kali Linux virtual machine) and monitoring/detection (on an Ubuntu VM using tools like Zeek, tcpdump and tshark). **These exercises are designed for educational purposes only.**

---

### üß∞ Tools Involved
  - **On Kali Linux (Attacker)**:
    - `arspoof` :
    - `hydra`: for brute force attacks on services like SSH or FTP
    - `dns2tcp`:

  - **On Ubuntu (Monitor/Target)**:
    - ####  `tcpdump` :
      - It's a command-line tool for capturing and inspecting network traffic in real time.
      - It listens on a network interface (e.g., eth0) and prints out packet information as it sees it. We can use filters (like port numbers, protocols, IPs) to focus on specific traffic too.
      - We'll use this tool to capture raw packets into `.pcap` files for deeper analysis later.

    - #### `wireshark` :
      - It's an open-source network protocol analyzer. It captures and displays packets of data that flow through a network, allowing the user to inspect what‚Äôs happening at a very detailed level (from the Ethernet frame all the way up to the application data).
      - **GUI for Packet Analysis:** We'll use this so we can visually analyze the `.pcap` files generated by `tcpdump`.

    - #### `zeek` :
      - Zeek is a powerful network analysis framework designed for detecting suspicious activity on a network. It‚Äôs used in security operations centers (SOCs).
      - It passively monitors traffic like `tcpdump`, but instead of just logging raw packets, it analyzes them and writes detailed logs:
        - `conn.log` ‚Üí all connection summaries
        - `http.log`, `ssh.log`, `dns.log`, etc. ‚Üí protocol-specific logs
        - `notice.log ` ‚Üí alerts about suspicious behavior

---

### üîó Connecting to the VMs

To perform attacks or monitor network traffic, we‚Äôll need terminal access to both virtual machines (Kali and Ubuntu). 

Since Azure Cloud Shell only allows one terminal session per VM at a time, it's recommended to connect to your VMs via SSH from your local computer.

#### Before connecting, make sure you have:

- The private SSH key (`key.pem`) that matches the public key used in `terraform.tfvars`.

üí° **Important:** Make sure your SSH key file has correct permissions:

```
chmod 600 key.pem
```
##

### üîê Connect to the VMs
To connect to a VM, open a terminal on your local computer and use the following command:

```
ssh -i path/to/key.pem azureuser@20.169.229.158
```
- Replace  `path/to/key.pem ` with the path to your private key file.

- `azureuser` is the admin username used in `terraform.tfvars`, if you changed it replace it here.
- Replace `20.169.229.158` with the public IP address of one of the VMs (output from Terraform).

Repeat this process to connect to the other VM or to open multiple terminal windows to run commands in parallel.

---

## ‚öîÔ∏è Attack Scenarios


### üëÅÔ∏è‚Äçüó®Ô∏è Monitoring Setup

Before running each attack, we will first configure our monitoring tools. This ensures that the traffic is properly captured and logged for analysis. By repeating this setup for every attack, we can:

- Keep evidence isolated per technique
- Make analysis easier and logs cleaner
- Create smaller and more focused .pcap files

This practice is especially important in labs like this one, where the goal is to learn and analyze each attack‚Äôs behavior individually.

- On a terminal connected to the Ubuntu VM, we run:

  ```
  sudo tcpdump -i eth0 -w tcp_conn.pcap
  ```
  - We'll name each output file based on the scan or attack being performed, so that the logs are organized and easier to identify later.

  **What this does:**

  - `-i eth0` ‚Üí Listen on interface **eth0** (the VM‚Äôs main network interface. We can always check using `ip link` or `ifconfig`, to be sure which one is actively transmitting and receiving data).

  - `-w tcp_conn.pcap` ‚Üí Write the raw captured packets directly to a file named `tcp_conn.pcap` (`tshark`, Wireshark's terminal version can also be used to do this). 

  - No filters applied ‚Üí Captures all traffic on that interface.
  -  `tcpdump` will start capturing traffic and writing it to the file `tcp_conn.pcap` .


- On another terminal connected to the Ubuntu VM, run: 
  ```
  sudo zeek -i eth0
  ```
  - This will run Zeek on the **eth0** interface.
  - Zeek passively monitors the network interface.
  - It will start logging immediately in the default directory (`/opt/zeek/logs/current/`).

- To see the log as it grows on real time, we can run on another terminal:
  ```
  tail -f /opt/zeek/logs/current/conn.log
  ```
##

### ü§ù TCP Handshake 
To understand how TCP Connect and SYN scans work (and SYN Floods, the attack we¬¥ll perform afterwards), it‚Äôs important to know how a typical TCP connection is established.

It¬¥s purpose is to establish a reliable connection between a client and a server to ensure that both sides are ready to communicate before any data is transmitted. This process is also known as the **3-way handshake**:

**1. SYN (Synchronize)  ‚Üí** The client sends a SYN packet to the server to request a connection.
   
**2.  SYN-ACK (Synchronize-Acknowledge)  ‚Üí**‚ÄÉIf the port is open, the server responds with a SYN-ACK.  The ACK flag acknowledges the client's initial SYN, and the SYN flag initiates the server's connection request back to the client.
   
**3.  ACK (Acknowledge) ‚Üí**‚ÄÉThe client sends back an ACK, acknowledging the server's SYN-ACK to complete the handshake. Both client and server are now aware of the connection and ready to transmit data.

üí° If any of these steps fail, the connection does not fully establish. This behavior is what scanners like nmap exploit to detect open, closed, or filtered ports.

##
### üïµÔ∏è 1. ARP Spoofing / Man-in-the-Middle (MITM) using Arpspoof
##

#### What is ARP?
 **ARP (Address Resolution Protocol)** is a communication protocol used in local networks to map **IP addresses** (like 10.0.0.4) to **MAC addresses** (**unique** hardware addresses like 00:1A:2B:3C:4D:5E assigned to network interfaces). This is essential for communication within a local network. ARP acts as a translator between the logical IP addresses used for routing and the physical MAC addresses used by network hardware. 

 **Important characteristics:**

- Devices maintain an ARP table to keep track of these mappings.

- Usually, devices use ARP to contact the router or gateway that enables them to connect to the Internet.
- Unfortunately, ARP is **unauthenticated**, meaning any device can send fake ARP messages.

##

####  ARP Spoofing
 In an **ARP spoofing attack**, an attacker tricks a victim (by sending forged ARP messages) into thinking the attacker‚Äôs MAC address is the gateway (router), and viceversa. This allows the attacker to:

  - Intercept and be in the middle of all communications **(Man-in-the-Middle)**

  - Launch further attacks like credential theft

üí° This kind of attack is local network based, meaning both machines need to be on the same subnet.
##
#### IP Fowarding and ARP Spoofing
IP forwarding allows the attacker (Kali VM) to act like a router ‚Äî forwarding traffic from one device to another. **IP forwarding essentially means: ‚Äúread and pass it along.‚Äù**

**Why does it matter with ARP Spoofing?:**

- When doing ARP spoofing (man-in-the-middle), both the victim and the gateway send their traffic to the attacker's machine, thinking it's the other.

- But unless the attacker forwards that traffic to the real destination (e.g., the gateway), the victim will lose connection (because packets get stuck on the attacker).

##

### üëÅÔ∏è‚Äçüó®Ô∏è Continue Monitoring on Ubuntu VM

1. Run the commands listed above on Monitoring Setup.
2. We¬¥ll name the file `tcpdump` is going to write on: `arp_spoofing.pcap`.

##

### ‚öîÔ∏è Performing the Attack:

- Run `ip route` on any VM to check the ip of the default gateway:

**IP Fowarding:**
- On a terminal connected to the Kali VM, run the following command:
  ```
  echo 1 | sudo tee /proc/sys/net/ipv4/ip_forward
  ```
  **Explanation:**

  - `echo 1` : Outputs the value 1 to standard output. In this context, 1 means "enable" (as in enabling a setting).

  - `|` : The pipe sends the output of echo 1 (which is just 1) as input to the next command, sudo tee.

  - `sudo tee /proc/sys/net/ipv4/ip_forward`: 

    - Uses `sudo` to run the command with superuser privileges (required to modify system settings).

    - `tee` is used to write input to a file (in this case, /proc/sys/net/ipv4/ip_forward).

    - The file /proc/sys/net/ipv4/ip_forward is a special kernel parameter in Linux. Writing 1 to this file **enables packet forwarding on the system**.


**Run arpspoof:** 
- After enabling ip fowarding, run the following command:

  ```
  sudo arpspoof -i eth0 -t 10.0.1.5 10.0.1.1
  sudo arpspoof -i eth0 -t 10.0.1.1 10.0.1.5
  ```
  **What it does:**

    - `sudo`: needs root to modify ARP tables.

    - `arpspoof` : tool that sends fake ARP responses.

    - `-i eth0` :  the network interface being used.

    - `10.0.1.5` : private ip from the Ubuntu VM.

    - `10.0.1.1` : default gateway.


  **Why two commands?**

    - **First one:** tell the victim ‚ÄúHey, I‚Äôm the gateway‚Äù

    - **Second one:** tell the gateway ‚ÄúHey, I‚Äôm the victim‚Äù

  üí° This way, both sides send their traffic to the Kali VM, thinking it's the other.


- Now the Kali VM is in the middle, and can sniff traffic with:
  ```
  sudo tcpdump -i eth0
  ```
##
#### While Running the Attack...
  - On a terminal connected to the Ubuntu VM, try pinging both the Kali VM and Google's DNS (8.8.8.8). This helps generate ARP traffic that can be captured and analyzed later.
  
    ```
    ping 10.0.1.4 -c 2
    ```
    ```
    ping 8.8.8.8 -c 2
    ```
  - These pings also help confirm that IP forwarding on Kali is working correctly. If the Ubuntu VM is still able to reach external addresses like 8.8.8.8, it means Kali is successfully forwarding packets between the victim and the gateway. 
  

    ```
    azureuser@ubuntu-vm:~$ ping 10.0.1.4 -c 2
    PING 10.0.1.4 (10.0.1.4) 56(84) bytes of data.
    64 bytes from 10.0.1.4: icmp_seq=1 ttl=64 time=1.71 ms
    64 bytes from 10.0.1.4: icmp_seq=2 ttl=64 time=0.972 ms
    --- 10.0.1.4 ping statistics ---
    2 packets transmitted, 2 received, 0% packet loss, time 1002ms
    rtt min/avg/max/mdev = 0.972/1.340/1.709/0.368 ms
    
    azureuser@ubuntu-vm:~$ ping 8.8.8.8 -c 2
    PING 8.8.8.8 (8.8.8.8) 56(84) bytes of data.
    64 bytes from 8.8.8.8: icmp_seq=1 ttl=112 time=1.93 ms
    64 bytes from 8.8.8.8: icmp_seq=2 ttl=112 time=1.84 ms
    --- 8.8.8.8 ping statistics ---
    2 packets transmitted, 2 received, 0% packet loss, time 1002ms
    rtt min/avg/max/mdev = 1.842/1.884/1.926/0.042 ms
    ```


##
### üìä Results and Analysis After an ARP Spoofing

- Stop Zeek and tcpdump using Ctrl + C after pinning .

### Attacker's Perspective:

  **ARP Spoofing Output:**
  
  ```
  ‚îå‚îÄ‚îÄ(azureuser„âøkali)-[~]
  ‚îî‚îÄ$ sudo arpspoof -i eth0 -t 10.0.1.5 10.0.1.1
  sudo arpspoof -i eth0 -t 10.0.1.1 10.0.1.5
  
  0:d:3a:8f:cc:a8 12:34:56:78:9a:bc 0806 42: arp reply 10.0.1.1 is-at 0:d:3a:8f:cc:a8
  0:d:3a:8f:cc:a8 12:34:56:78:9a:bc 0806 42: arp reply 10.0.1.1 is-at 0:d:3a:8f:cc:a8
  0:d:3a:8f:cc:a8 12:34:56:78:9a:bc 0806 42: arp reply 10.0.1.1 is-at 0:d:3a:8f:cc:a8
  0:d:3a:8f:cc:a8 12:34:56:78:9a:bc 0806 42: arp reply 10.0.1.1 is-at 0:d:3a:8f:cc:a8

  ```
  
  **Let‚Äôs break this line down:**
  ```
  0:d:3a:8f:cc:a8 12:34:56:78:9a:bc 0806 42: arp reply 10.0.1.1 is-at 0:d:3a:8f:cc:a8
  ```
  
  | Part                             | Meaning                                                       |
  | -------------------------------- | ------------------------------------------------------------- |
  | `0:d:3a:8f:cc:a8`                | **Source MAC** address (Kali VM‚Äôs MAC)                        |
  | `12:34:56:78:9a:bc`              | Kali¬¥s MAC in disguise (spoofed)                              |
  | `0806`                           | Ethernet type ‚Äî **`0x0806` = ARP**                            |
  | `42`                             | Packet length in bytes                                        |
  | `arp reply`                      | Type of ARP message                                           |
  | `10.0.1.1 is-at 0:d:3a:8f:cc:a8` | ARP message content: "`10.0.1.1` is at the (attacker‚Äôs) MAC"  |

  - This poisons the victim‚Äôs ARP cache and causes traffic intended for the gateway to be redirected through the attacker ‚Äî **enabling a Man-in-the-Middle attack.**
  
  **Kali VM's Real MAC Address**:
  ```
  ‚îå‚îÄ‚îÄ(azureuser„âøkali)-[~]
  ‚îî‚îÄ$ ip link show eth0
  2: eth0: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc mq state UP mode DEFAULT group qlen 1000
      link/ether 00:0d:3a:8f:cc:a8 brd ff:ff:ff:ff:ff:ff
   ```   
  
  This command's output confirms that the MAC address of the Kali VM is `0:d:3a:8f:cc:a8`.

### Target's Perspective:

**Analyzing `arp_spoofing.pcap` and Filtering ARP Packets with `tshark`:**
- To analyze the ARP Spoofing attack from the victim‚Äôs point of view, we start by inspecting only the ARP packets captured in the `.pcap` file. This helps us focus on the address resolution activity during the attack.

We use the following command:
```
tshark -r arp_spoofing.pcap -Y "arp"
```
**Explanation:**

- `-r` arp_spoofing.pcap: Reads the packet capture file.

- `-Y "arp"`: Displays only the packets that belong to the ARP protocol.

This filtered view makes it easier to spot abnormal ARP behavior, such as forged replies.

**Output:**

   
  ```
  azureuser@ubuntu-vm:~$ tshark -r arp_spoofing.pcap -Y "arp"

  113  16.942700 Microsof_2f:f5:00 ‚Üí Broadcast    ARP 42 Who has 10.0.1.4? Tell 10.0.1.5
  114  16.943066 12:34:56:78:9a:bc ‚Üí Microsof_2f:f5:00 ARP 42 10.0.1.4 is at 12:34:56:78:9a:bc
  766 100.543456 Microsof_2f:f5:00 ‚Üí Broadcast    ARP 42 Who has 10.0.1.1? Tell 10.0.1.5
  767 100.543709 Microsof_2f:f5:00 ‚Üí Broadcast    ARP 42 Who has 10.0.1.1? Tell 10.0.1.5
  768 100.544278 12:34:56:78:9a:bc ‚Üí Microsof_2f:f5:00 ARP 42 10.0.1.1 is at 12:34:56:78:9a:bc
  769 100.544278 12:34:56:78:9a:bc ‚Üí Microsof_2f:f5:00 ARP 42 10.0.1.1 is at 12:34:56:78:9a:bc
  863 113.011002 Microsof_2f:f5:00 ‚Üí Broadcast    ARP 42 Who has 10.0.1.4? Tell 10.0.1.5
  865 113.011502 12:34:56:78:9a:bc ‚Üí Microsof_2f:f5:00 ARP 42 10.0.1.4 is at 12:34:56:78:9a:bc
  1229 157.865869 Microsof_2f:f5:00 ‚Üí 12:34:56:78:9a:bc ARP 42 Who has 10.0.1.4? Tell 10.0.1.5
  1230 157.866846 12:34:56:78:9a:bc ‚Üí Microsof_2f:f5:00 ARP 42 10.0.1.4 is at 12:34:56:78:9a:bc
 ```

**Wireshark Evidence**

- In addition to viewing the ARP traffic directly in the terminal, transferring the `.pcap` file locally and opening it on Wireshark can provide a clearer visualization of the analized log.

- The screenshot below shows the same ARP spoofing exchange‚Äîhighlighting how the victim believes the gateway (`10.0.1.1`) is at the attacker's MAC address.


**Analyzing the Output:**


From the victim‚Äôs perspective (`10.0.1.5`), several ARP requests are made for:

- `10.0.1.4`: the attacker's IP.

- `10.0.1.1`: the legitimate gateway IP.

In each case, the replies come from the MAC address `12:34:56:78:9a:bc`, which responds on behalf of both `10.0.1.4` and `10.0.1.1`.

- Seeing the same MAC address associated with two different IPs (gateway and attacker) is a major red flag. **MAC addresses are supposed to be unique identifiers tied to a single physical or virtual network interface. This duplication is a key indicator of ARP spoofing.**


- By poisoning the victim‚Äôs ARP cache with this fake mapping, the attacker tricks the victim into sending traffic meant for the gateway to the attacker‚Äôs machine instead. **This enables a Man-in-the-Middle (MITM) attack**, allowing the attacker to intercept or forward the traffic at will.


##
### üîê 2. Brute-force SSH using Hydra
##

The goal is to simulate a brute-force login attack by trying multiple passwords against the SSH service on the Ubuntu VM.

#### What is a Brute-force Attack?

A brute-force attack is a trial-and-error method used to gain unauthorized access to a system by systematically trying a large number of possible username and password combinations. The goal is to eventually guess the correct credentials through persistence.

- In the context of SSH (Secure Shell), a brute-force attack attempts to log in to the target machine by repeatedly trying different passwords for a known username, often using a wordlist that contains thousands or millions of common or leaked passwords.

- These attacks are **noisy, easily detectable**, and can be mitigated with rate-limiting, account lockout mechanisms, or intrusion detection systems.

##
#### üìÑ Password List
Before running the attack, ensure you have access to a password list. In this case, we'll use the popular **rockyou.txt** wordlist. This is a widely used wordlist that contains millions of the most common passwords.

It originated from a real-world data breach and is commonly used in penetration testing and brute-force attacks. It is included in Kali Linux by default, but it's compressed.

To prepare it for use, **decompress it** with:
```
sudo gunzip /usr/share/wordlists/rockyou.txt.gz
```

Once decompressed, it will be available at:
```
/usr/share/wordlists/rockyou.txt
```

##

#### üëÅÔ∏è‚Äçüó®Ô∏è Continue Monitoring on Ubuntu VM

1. Run the commands listed above on Monitoring Setup.
2. We¬¥ll name the file `tcpdump` is going to write on: `brute_force.pcap`.

##
#### ‚öîÔ∏è Performing the Attack:

On a terminal connected to the Kali VM, run the following command:
```
hydra -l azureuser -P /usr/share/wordlists/rockyou.txt ssh://10.0.1.X
```
Hydra attempts many SSH login attempts in rapid succession using common passwords. If any attempt succeeds, it will be shown in the output.

**Command Breakdown:**

| Flag             | Meaning                                                                  |
| ---------------- | ------------------------------------------------------------------------ |
| `-l azureuser`   | Attempt to login as user "azureuser"                                     |
| `-P rockyou.txt` | Use the popular rockyou wordlist (common passwords) as the password list |
| `ssh://...`      | Specifies the protocol (SSH) and the target IP address                   |


##
### üìä Results and Analysis After a Brute Force Attack
- Stop Zeek and tcpdump using Ctrl + C once the attack completes.

#### Attacker's Perspective:

- Hydra will display real-time output of the attempts being made.

- If the correct password is found, it will be clearly shown:

- Even if unsuccessful, you‚Äôll see how many passwords were tried and how long it took.

#### Target's Perspective:

After the attack, we analyze the logs and traffic to detect signs of brute-force behavior. This helps confirm that our monitoring setup can detect such attacks.


  #### Detecting SSH Brute Force Using Logs and Packet Capture
- Zeek's log: /opt/zeek/logs/current/conn.log

- Zeek tracks all connection attempts, including failed ones. Signs of brute-force include:

  - Numerous short-lived connections from the same source IP (Kali)

  - Repeated connection attempts to port 22 (SSH)

  - State field values such as:

    - S0 (SYN sent, no reply)

    - SF (connection established and finished normally, may happen once password is guessed)

    - RSTO or RSTR (indicates resets from either side)

  Sample Zeek filter:
  ```
  cat conn.log | zeek-cut id.orig_h id.resp_p proto service duration conn_state
  ```
  - Many entries with service ssh, same origin IP, short durations, failed connections.

#### SSH Authentication Log (Ubuntu VM):
- Check system logs to see login attempts:
  ```
  sudo cat /var/log/auth.log | grep sshd
  ```
Signs of brute-force:



#### Tcpdump pcap file: brute_force.pcap

- Analyze packet captures using Wireshark or TShark:
  ```
  tshark -r brute_force.pcap
  ```

  - Multiple TCP connections to port 22 from the same IP

  - Several failed authentication attempts in SSH protocol stream

  - Short durations and quick re-establishing of connections

- Wireshark filter to focus on SSH traffic:
  ```
  tcp.port == 22
  ```
