# üõ†Ô∏è Part 2: Simulating Attacks and Analyzing Traffic

This section explains how to use the infrastructure created in [Part 1: Building the Cyber Lab Environment](README_PART1.md) to demonstrate several real-world cyberattacks in a controlled Azure environment, showcasing both offensive techniques (from a Kali Linux virtual machine) and monitoring/detection (on an Ubuntu VM using tools like Zeek, tcpdump and tshark). **These exercises are designed for educational purposes only.**

---

### üß∞ Tools Involved
  - **On Kali Linux (Attacker)**:
    - `arspoof` :
    - `hydra`: for brute force attacks on services like SSH or FTP
    - `dns2tcp`:

  - **On Ubuntu (Monitor/Target)**:
    - ####  `tcpdump` :
      - It's a command-line tool for capturing and inspecting network traffic in real time.
      - It listens on a network interface (e.g., eth0) and prints out packet information as it sees it. We can use filters (like port numbers, protocols, IPs) to focus on specific traffic too.
      - We'll use this tool to capture raw packets into `.pcap` files for deeper analysis later.

    - #### `wireshark` :
      - It's an open-source network protocol analyzer. It captures and displays packets of data that flow through a network, allowing the user to inspect what‚Äôs happening at a very detailed level (from the Ethernet frame all the way up to the application data).
      - **GUI for Packet Analysis:** We'll use this so we can visually analyze the `.pcap` files generated by `tcpdump`.

    - #### `zeek` :
      - Zeek is a powerful network analysis framework designed for detecting suspicious activity on a network. It‚Äôs used in security operations centers (SOCs).
      - It passively monitors traffic like `tcpdump`, but instead of just logging raw packets, it analyzes them and writes detailed logs:
        - `conn.log` ‚Üí all connection summaries
        - `http.log`, `ssh.log`, `dns.log`, etc. ‚Üí protocol-specific logs
        - `notice.log ` ‚Üí alerts about suspicious behavior

---

### üîó Connecting to the VMs

To perform attacks or monitor network traffic, we‚Äôll need terminal access to both virtual machines (Kali and Ubuntu). 

Since Azure Cloud Shell only allows one terminal session per VM at a time, it's recommended to connect to your VMs via SSH from your local computer.

#### Before connecting, make sure you have:

- The private SSH key (`key.pem`) that matches the public key used in `terraform.tfvars`.

üí° **Important:** Make sure your SSH key file has correct permissions:

```
chmod 600 key.pem
```
##

### üîê Connect to the VMs
To connect to a VM, open a terminal on your local computer and use the following command:

```
ssh -i path/to/key.pem azureuser@20.169.229.158

```
- Replace  `path/to/key.pem ` with the path to your private key file.

- `azureuser` is the admin username used in `terraform.tfvars`, if you changed it replace it here.
- Replace `20.169.229.158` with the public IP address of one of the VMs (output from Terraform).

Repeat this process to connect to the other VM or to open multiple terminal windows to run commands in parallel.

---

## ‚öîÔ∏è Attack Scenarios


### üëÅÔ∏è‚Äçüó®Ô∏è Monitoring Setup

Before running each attack, we will first configure our monitoring tools. This ensures that the traffic is properly captured and logged for analysis. By repeating this setup for every attack, we can:

- Keep evidence isolated per technique
- Make analysis easier and logs cleaner
- Create smaller and more focused .pcap files

This practice is especially important in labs like this one, where the goal is to learn and analyze each attack‚Äôs behavior individually.

- On a terminal connected to the Ubuntu VM, we run:

  ```
  sudo tcpdump -i eth0 -w tcp_conn.pcap
  ```
  - We'll name each output file based on the scan or attack being performed, so that the logs are organized and easier to identify later.

  **What this does:**

  - `-i eth0` ‚Üí Listen on interface **eth0** (the VM‚Äôs main network interface. We can always check using `ip link` or `ifconfig`, to be sure which one is actively transmitting and receiving data).

  - `-w tcp_conn.pcap` ‚Üí Write the raw captured packets directly to a file named `tcp_conn.pcap` (`tshark`, Wireshark's terminal version can also be used to do this). 

  - No filters applied ‚Üí Captures all traffic on that interface.
  -  `tcpdump` will start capturing traffic and writing it to the file `tcp_conn.pcap` .


- On another terminal connected to the Ubuntu VM, run: 
  ```
  sudo zeek -i eth0
  ```
  - This will run Zeek on the **eth0** interface.
  - Zeek passively monitors the network interface.
  - It will start logging immediately in the default directory (`/opt/zeek/logs/current/`).

- To see the log as it grows on real time, we can run on another terminal:
  ```
  tail -f /opt/zeek/logs/current/conn.log
  ```
##

### ü§ù TCP Handshake 
To understand how TCP Connect and SYN scans work (and SYN Floods, the attack we¬¥ll perform afterwards), it‚Äôs important to know how a typical TCP connection is established.

It¬¥s purpose is to establish a reliable connection between a client and a server to ensure that both sides are ready to communicate before any data is transmitted. This process is also known as the **3-way handshake**:

**1. SYN (Synchronize)  ‚Üí** The client sends a SYN packet to the server to request a connection.
   
**2.  SYN-ACK (Synchronize-Acknowledge)  ‚Üí**‚ÄÉIf the port is open, the server responds with a SYN-ACK.  The ACK flag acknowledges the client's initial SYN, and the SYN flag initiates the server's connection request back to the client.
   
**3.  ACK (Acknowledge) ‚Üí**‚ÄÉThe client sends back an ACK, acknowledging the server's SYN-ACK to complete the handshake. Both client and server are now aware of the connection and ready to transmit data.

üí° If any of these steps fail, the connection does not fully establish. This behavior is what scanners like nmap exploit to detect open, closed, or filtered ports.

##
### üïµÔ∏è 1. ARP Spoofing / Man-in-the-Middle (MITM) using Arspoof
##

#### What is ARP?
 **ARP (Address Resolution Protocol)** is communication protocol used in local networks to map **IP addresses** (like 10.0.0.4) to **MAC addresses** (**unique** hardware addresses like 00:1A:2B:3C:4D:5E assigned to network interfaces). This is essential for communication within a local network. It acts as a translator between the logical IP addresses used for routing and the physical MAC addresses used by network hardware. 

 **Important characteristics:**

- Devices maintain an ARP table to keep track of these mappings.

- Usually, devices use ARP to contact the router or gateway that enables them to connect to the Internet.
- Unfortunately, ARP is unauthenticated, meaning any device can send fake ARP messages.

##

####  ARP Spoofing
 In an **ARP spoofing attack**, an attacker tricks a victim (Ubuntu VM), by sending forged ARP messages, into thinking the attacker‚Äôs MAC address is the gateway (router) and viceversa. This allows the attacker to:

  - Intercept and be in the middle of all communications **(Man-in-the-Middle)**

  - Modify or drop packets

  - Launch further attacks like credential theft

üí° It‚Äôs local network based, meaning both machines need to be on the same subnet.
##
#### IP Fowarding and ARP Spoofing
IP forwarding allows the attacker (Kali VM) to act like a router ‚Äî forwarding traffic from one device to another. **IP forwarding means: ‚Äúread and pass it along.‚Äù**

**Why does it matter wirth ARP Spoofing?:**

- When doing ARP spoofing (man-in-the-middle), both the victim and the gateway send their traffic to the attacker's machine, thinking it's the other.

- But unless the attacker forwards that traffic to the real destination (e.g., the gateway), the victim will lose connection (because packets get stuck on the attacker).

##

#### üëÅÔ∏è‚Äçüó®Ô∏è Continue Monitoring on Ubuntu VM

1. Run the commands listed above on Monitoring Setup.
2. We¬¥ll name the file `tcpdump` is going to write on: `arp_spoofing.pcap`.

##

#### ‚öîÔ∏è Performing the Attack:

- Run `ip route` on any VM to verify the default gateway:

**IP Fowarding:**
- On a terminal connected to the Kali VM, run the following command:
  ```
  echo 1 | sudo tee /proc/sys/net/ipv4/ip_forward
  ```
  **Explanation:**

  - `echo 1` : Outputs the value 1 to standard output. In this context, 1 means "enable" (as in enabling a setting).

  - `|` : The pipe sends the output of echo 1 (which is just 1) as input to the next command, sudo tee.

  - `sudo tee /proc/sys/net/ipv4/ip_forward`: 

    - Uses `sudo` to run the command with superuser privileges (required to modify system settings).

    - `tee` is used to write input to a file (in this case, /proc/sys/net/ipv4/ip_forward).

    - The file /proc/sys/net/ipv4/ip_forward is a special kernel parameter in Linux. Writing 1 to this file **enables packet forwarding on the system**.


**Run arpspoof:** 
- After enabling ip fowarding, run the following command:

  ```
  sudo arpspoof -i eth0 -t 10.0.1.5 10.0.1.1
  sudo arpspoof -i eth0 -t 10.0.1.1 10.0.1.5

  ```
  **What it does:**

    - `sudo`: needs root to modify ARP tables.

    - `arpspoof` : tool that sends fake ARP responses.

    - `-i eth0` :  the network interface being used.

    - `10.0.1.5` : private ip from the Ubuntu VM.

    - `10.0.1.1` : default gateway.


  **Why two commands?**

    - **First one:** tell the victim ‚ÄúHey, I‚Äôm the gateway‚Äù

    - **Second one:** tell the gateway ‚ÄúHey, I‚Äôm the victim‚Äù

  üí° This way, both sides send their traffic to the Kali VM, thinking it's the other.


- Now the Kali VM is in the middle, and can sniff traffic with:
  ```
  sudo tcpdump -i eth0
  ```

**On the Victim:**
- On a terminal connected to the Ubuntu VM, try pinning google.com and the Kali VM, this is to generate ARP traffic, to analyze later:

  ```
  ping 10.0.1.4 -c 2
  ```
  ```
  ping 8.8.8.8 -c 2
  ```


##
### üìä Results and Analysis After an ARP Spoofing
- Stop Zeek and tcpdump using Ctrl + C after pinning .

#### Attacker's Perspective:

**Outputs:**



#### Target's Perspective:
**Output:**

**Logs and Filters:**


##
### üîê 2. Brute-force SSH using Hydra
##

The goal is to simulate a brute-force login attack by trying multiple passwords against the SSH service on the Ubuntu VM.

#### What is a Brute-force Attack?

A brute-force attack is a trial-and-error method used to gain unauthorized access to a system by systematically trying a large number of possible username and password combinations. The goal is to eventually guess the correct credentials through persistence.

- In the context of SSH (Secure Shell), a brute-force attack attempts to log in to the target machine by repeatedly trying different passwords for a known username, often using a wordlist that contains thousands or millions of common or leaked passwords.

- These attacks are **noisy, easily detectable**, and can be mitigated with rate-limiting, account lockout mechanisms, or intrusion detection systems.

##
#### üìÑ Password List
Before running the attack, ensure you have access to a password list. In this case, we'll use the popular **rockyou.txt** wordlist. This is a widely used wordlist that contains millions of the most common passwords.

It originated from a real-world data breach and is commonly used in penetration testing and brute-force attacks. It is included in Kali Linux by default, but it's compressed.

To prepare it for use, **decompress it** with:
```
sudo gunzip /usr/share/wordlists/rockyou.txt.gz
```

Once decompressed, it will be available at:
```
/usr/share/wordlists/rockyou.txt
```

##

#### üëÅÔ∏è‚Äçüó®Ô∏è Continue Monitoring on Ubuntu VM

1. Run the commands listed above on Monitoring Setup.
2. We¬¥ll name the file `tcpdump` is going to write on: `brute_force.pcap`.

##
#### ‚öîÔ∏è Performing the Attack:

On a terminal connected to the Kali VM, run the following command:
```
hydra -l azureuser -P /usr/share/wordlists/rockyou.txt ssh://10.0.1.X
```
Hydra attempts many SSH login attempts in rapid succession using common passwords. If any attempt succeeds, it will be shown in the output.

**Command Breakdown:**

| Flag             | Meaning                                                                  |
| ---------------- | ------------------------------------------------------------------------ |
| `-l azureuser`   | Attempt to login as user "azureuser"                                     |
| `-P rockyou.txt` | Use the popular rockyou wordlist (common passwords) as the password list |
| `ssh://...`      | Specifies the protocol (SSH) and the target IP address                   |


##
### üìä Results and Analysis After a Brute Force Attack
- Stop Zeek and tcpdump using Ctrl + C once the attack completes.

#### Attacker's Perspective:

- Hydra will display real-time output of the attempts being made.

- If the correct password is found, it will be clearly shown:

- Even if unsuccessful, you‚Äôll see how many passwords were tried and how long it took.

#### Target's Perspective:

After the attack, we analyze the logs and traffic to detect signs of brute-force behavior. This helps confirm that our monitoring setup can detect such attacks.


  #### Detecting SSH Brute Force Using Logs and Packet Capture
- Zeek's log: /opt/zeek/logs/current/conn.log

- Zeek tracks all connection attempts, including failed ones. Signs of brute-force include:

  - Numerous short-lived connections from the same source IP (Kali)

  - Repeated connection attempts to port 22 (SSH)

  - State field values such as:

    - S0 (SYN sent, no reply)

    - SF (connection established and finished normally, may happen once password is guessed)

    - RSTO or RSTR (indicates resets from either side)

  Sample Zeek filter:
  ```
  cat conn.log | zeek-cut id.orig_h id.resp_p proto service duration conn_state
  ```
  - Many entries with service ssh, same origin IP, short durations, failed connections.

#### SSH Authentication Log (Ubuntu VM):
- Check system logs to see login attempts:
  ```
  sudo cat /var/log/auth.log | grep sshd
  ```
Signs of brute-force:



#### Tcpdump pcap file: brute_force.pcap

- Analyze packet captures using Wireshark or TShark:
  ```
  tshark -r brute_force.pcap
  ```

  - Multiple TCP connections to port 22 from the same IP

  - Several failed authentication attempts in SSH protocol stream

  - Short durations and quick re-establishing of connections

- Wireshark filter to focus on SSH traffic:
  ```
  tcp.port == 22
  ```
